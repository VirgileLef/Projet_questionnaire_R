---
title: "Analyse des réponses du questionnaire"
author: "Virgile"
date: "2025-12-01"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
# Chargement des bibliothèques
library(tidyverse)
library(viridis)
library(knitr) 
library(kableExtra)
library(yaml)

# 1. Chargement des données et configuration
config <- yaml::read_yaml("input/config_questionnaire.yaml")
data <- read.csv2(
  file = config$files$input_data, 
  fileEncoding = config$files$encoding, 
  sep = config$files$separator, 
  check.names = FALSE
)

# Fonction de nettoyage des caractères spéciaux
clean_text <- function(x) {
  x <- gsub('[\u0093\u0094\u201C\u201D]', '"', x)
  x <- gsub('œ', 'oe', x)
  x <- iconv(x, to = "ASCII//TRANSLIT")
  x <- gsub('[^\x20-\x7E]', '', x)
  return(x)
}

# Application du nettoyage
names(data) <- clean_text(names(data))
data <- data %>% mutate(across(where(is.character), clean_text))

# Conversion des dates selon la configuration
for (col_conf in config$columns) {
  if (col_conf$type == "date") {
    col_name <- col_conf$name
    data[[col_name]] <- as.Date(data[[col_name]], format = col_conf$format)
  }
}

# Import des fonctions externes
source("script/Fonction_graph_histogramme.R")
source("script/Fonction_graph_courbe.R")
source("script/Fonction_detect_var_type.R")
source("script/Fonction_compt_des_rep.R")
source("script/Fonction_tableau_d_effectif.R")
source("script/Fonction_graph_en_bar.R")
source("script/Fonction_graph_camembert.R")
```

## Analyse univarié

```{r, echo=FALSE, warning=FALSE, results='asis'}
for(i in names(data)) {
  
  # --- VARIABLES QUALITATIVES (Character) ---
  if(is.character(data[[i]])) {
    cat("\n### Analyse de la variable : ", i, "\n\n")
    
    # 1. Tableau d'effectifs agrandi
    tab_eff <- tableau_d_effectif(data[[i]], i)
    print(knitr::kable(tab_eff))
    
    cat("\n")
    
    # 2. Graphiques
    print(graph_en_bar(data[[i]], i))
    cat("\n\n")
    print(graph_camembert(data[[i]], i))
    
    cat("\n\n\\newpage\n\n")
  }
  
  # --- VARIABLES TEMPORELLES (Date) ---
  if(inherits(data[[i]], "Date")) {
    cat("\n### Analyse de la variable : ", i, "(Date)", "\n\n")
    
    # Affichage de la courbe (avec graduation 1 en 1 si modifiée dans la fonction)
    print(graph_courbe(data[[i]], i))
    
    cat("\n\n\\newpage\n\n")
  }
  
  # --- VARIABLES NUMÉRIQUES ---
  if(is.numeric(data[[i]]) && !inherits(data[[i]], "Date")) {
    cat("\n### Analyse de la variable : ", i, "(Numérique)", "\n\n")
    
    # Résumé statistique agrandi
    stats <- as.data.frame(t(as.matrix(summary(data[[i]]))))
    
    print(
      knitr::kable(stats, format = "latex", booktabs = TRUE, caption = "Résumé statistique") %>%
      kable_styling(
        latex_options = c("striped", "hold_position"),
        font_size = 12
      )
    )
    
    cat("\n")
    
    print(graph_histogramme(data[[i]], i))
    
    cat("\n\n\\newpage\n\n")
  }
}
```